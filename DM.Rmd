---
author : "Khalil Janbek, Romain Jouhameau"
date: "01/01/2022"
output:
  pdf_document: 
  html_document:
    df_print: paged
editor_options: 
  markdown: 
    wrap: 72
    
header-includes:
  \usepackage[english]{babel}
  \usepackage[T1]{fontenc}
  \usepackage{tgbonum}
  \usepackage{multicol,multirow}
  \usepackage{calc}
  \usepackage{graphicx}
  \usepackage{rotating}
  \usepackage{tgtermes} 
  \usepackage{fancyhdr} 
  \usepackage{float} 
  \usepackage{xcolor} 
  \usepackage{geometry} 
  \usepackage{amsfonts} 
  \usepackage{booktabs}
  \usepackage{siunitx}
  \newcolumntype{d}{S[input-symbols = ()]}
  
  \geometry{left=0.8in,right=0.8in,top=1.0in,bottom=1.0in}
  \setlength{\parindent}{1.25em}
  \setlength{\parskip}{0.1em}
  
  \title{Applied Econometrics Homework \\ M2 FE }
---

```{=tex}
\pagestyle{fancy}
\fancyhf{}
\rhead{Khalil Janbek, Jouhameau Romain}
\lhead{Applied Econometrics Homework}
\rfoot{Page \thepage}
\maketitle
```
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      message=FALSE, 
                      warning=FALSE,  
                      results = "hold",
                      out.width = '70%',
                      fig.align='center',
                      comment = "#>")
```

```{r}
library(data.table)
library(dtplyr)
library(dplyr, warn.conflicts = FALSE)
library(readxl)
library(janitor)
library(plm)
library(modelsummary)
library(kableExtra)
library(ggrepel) # for spacing text inside plots
library(tidyverse)
library(sf)
library(usmap)
library(tsibble)
library(DBI) 
library(DataExplorer)
library(patchwork)
```

```{r}
con <- dbConnect(RSQLite::SQLite(), "Data/DB.sqlite")
DB = tbl(con, "DB")

DB %>% 
  head() %>% 
  collect()
```



\newpage

## PART A:

#### Option 1 - Master thesis dataset

Khalil's Master thesis explores the topic of the performance of securitized mortgage loans in the US in the context of the coronavirus crisis. Based on issuance and performance data for more than 346,724 mortgage loans purchased by Freddie Mac in 2020Q1, combined with neighborhood-level coronavirus data, the thesis will examine, at the US local level, whether the coronavirus outbreak affected these loans' (i) delinquency status and (ii) prepayment. In parallel, the Master thesis also enquires whether the status of the lender that originated the loan - commercial bank or shadow bank, Fintech or not - has an influence on those two loan performance metrics. 

\newpage


#### 1. In your data set, which are the variables which are varying with respect to two indices (or more if you consider inflows and outflows from one individual or country to another individual or countries? Which are the variables which are varying only with respect to time? Which are the variables which are varying only with respect to individuals?


For each loan, the database records: 

- (i) time-invariant issuance metrics. Those variables vary only  with respect to individuals (in other words by loan) and do not vary over. Those time-invariant variables regroup for instance borrower credit score at issuance, the original loan to value, XXX and the lender type. 

- (ii) time-varying performance metrics. Those variables vary both with respect to time and with respect to individuals. For instance, prepayment (Zero Balance Code), Delinquency status, and unpaid principal. 



#### 2. What is the largest number of period T for individuals? What is the number of individuals?


The dataset counts 17 time periods, spanning from a month in 2020Q1 to June 2021. The sample consists of 346,724 loans, originated at various dates but purchased by Freddie Mac in 2020Q1. 

```{r}
DB %>% 
  count(Loan_Seq_Number) %>% 
  summarise(Number_Loans = n(),
            Max_T = max(n, na.rm = TRUE),
            Min_T = min(n, na.rm = TRUE),
            Mean_T = mean(n, na.rm = TRUE),
            Median_T = median(n, na.rm = TRUE),
            ) %>% 
  collect()
```
Lenders originating and selling these mortgage loans are classified as either commercial banks or shadow banks. The latter category also includes Fintech lenders. 

```{r}
DB %>%  
  mutate(Type = case_when(
           Lender_Type == 1 ~ 'Bank',
           Lender_Type == 0 & Fintech == 0 ~ 'Shadow Bank',
           Lender_Type == 0 & Fintech == 1 ~ 'Fintech'
         )) %>% 
  group_by(Type) %>% 
  count(Loan_Seq_Number) %>% 
  summarise(Number_Loans = n(),
                   Max_T = max(n, na.rm = TRUE),
                   Min_T = min(n, na.rm = TRUE),
                   Mean_T = mean(n, na.rm = TRUE),
                   Median_T = median(n, na.rm = TRUE)) %>% 
  collect()
```

\newpage



#### 3. Comment on the structure of the unbalanced panel (how many (and which) countries have a single observation, discontinuities between observations, how many have at least 2 consecutive observations (which is useful to compute lags, autocorrelations, first difference and within estimators)?

As shown in the previous question, our dataset has an unbalanced panel data structure, with time periods per individual loan varying from 1 to 17.



```{r}
DB %>%
  group_by(Loan_Seq_Number) %>%
  tally() %>% 
  count(n) %>%
  rename(Number_Periods_available = n,
         Number_of_loans = nn) %>% 
  mutate(cum = cumsum(Number_of_loans),
         percent = 100 * (cum / 346724))
```




```{r}
DB_temp <- DB %>% 
  # Reformatting the "Zero Balance Code" variable: 1 if prepaid, 0 otherwise
  mutate(Zero_Balance_Code = ifelse(Zero_Balance_Code == 1, 1, 0),
         Zero_Balance_Code = ifelse(is.na(Zero_Balance_Code) == T, 0, Zero_Balance_Code)) %>% 
  # Reformatting the "Delinquency status" variable: counting "REO acquisition as "NA"
  mutate(Delinquency_Status = ifelse(Delinquency_Status == 'RA', NA, Delinquency_Status)) %>% 
  # Reformatting the "Estimated Loan-to-Value" variable: counting "999" as "NA"
  mutate(E_LoanToValue = ifelse(E_LoanToValue == 999, NA, E_LoanToValue)) %>% 
  # Reformatting the "Original Debt-to-Income" variable: counting "999" as "NA"
  mutate(O_DebtToIncome = ifelse(O_DebtToIncome == 999, NA, O_DebtToIncome)) 
```


```{r}
DB_KJ <- DB_temp %>% 
  select(Loan_Seq_Number, Reporting_Period, Delinquency_Status, Zero_Balance_Code,
         confirmed, Credit_score, Current_Interest_Rate,Current_UPB, E_LoanToValue,
         O_DebtToIncome, O_LoanToValue, Time_to_Maturity, Lender_Type, Fintech, MSA, Seller_Name) %>% 
  mutate(Delinquency_Status = as.integer(Delinquency_Status)) %>% 
  collect() %>% 
  mutate_if(is.integer, as.double)
```


```{r}
Loans_by_MSA <- 
  DB_temp %>%                             
  group_by(MSA) %>%
  summarise(LoansPerMSA = n_distinct(Loan_Seq_Number)) %>% 
  collect() %>% 
  arrange(desc(LoansPerMSA))

Loans_by_MSA

# Identifying which loans are not related to an MSA (22,351 / 346,724)
#sum(Loans_by_MSA$LoansPerMSA)
```



\newpage

```{r}
full_dates <- DB %>%
  group_by(Loan_Seq_Number) %>%
  tally() %>% 
  filter(n == 17) %>% 
  pull(Loan_Seq_Number)

DB_test <- DB_KJ %>% 
  filter(Loan_Seq_Number %in% full_dates)
```


```{r eval=FALSE, include=FALSE}
# NOT RUUUUNNNNNN
DB_test %>% 
  group_by(Loan_Seq_Number) %>% 
  summarise_if(is.double, mean, na.rm = T) %>% 
  collect() %>% 
  lm(Current_UPB ~ Current_Interest_Rate, data = .) %>% 
  summary()



plm(Current_UPB ~ Current_Interest_Rate, 
                    data = DB_test,
                    index = c("Loan_Seq_Number", "Reporting_Period"), 
                    model = "between") %>% 
  summary()


# Within transformation
test <- DB_test %>% 
  group_by(Loan_Seq_Number) %>% 
  mutate_at(vars(Delinquency_Status:Fintech), ~ . -  mean(., na.rm = T)) %>% 
  collect() 


library(fixest)
res = feols(Current_UPB ~  Current_Interest_Rate | Loan_Seq_Number, test, panel.id = ~Loan_Seq_Number+Reporting_Period)
# By default, the SEs are clustered according to the first fixed-effect
etable(res, cluster = c('Loan_Seq_Number', 'Reporting_Period'))


res = feols(Current_UPB ~  Current_Interest_Rate | Loan_Seq_Number + Reporting_Period, test, panel.id = ~Loan_Seq_Number+Reporting_Period)
# By default, the SEs are clustered according to the first fixed-effect
etable(res, cluster = c('Loan_Seq_Number', 'Reporting_Period'))



fatal_btw_mod <- plm(Current_UPB ~ Current_Interest_Rate, 
                    data = DB_test,
                    index = c("Loan_Seq_Number", "Reporting_Period"), 
                    model = "within")

summary(fatal_btw_mod)


lmtest::coeftest(fatal_btw_mod, vcov. = vcovHC, type = "HC1", method = "white1")

TEST2 <- pdata.frame(DB_test, index = c('Loan_Seq_Number', 'Reporting_Period'))

plm::between(TEST2$Current_UPB)
```







Starting by exploring missing observations, the graph shows that 6.75% of monthly loan performance observations relate to mortgage loans originated in locations that are not in an MSA - amounting to 22,351 loans, or 6.4% of the total of mortgages in our database. Those loans are likely to have been originated in sparsely populated areas.  

Monthly developments in COVID-19 confirmed cases by MSA are also missing in 8.45% of our monthly loan performance observations. This percentage includes the 6.75% of loan performance observations that are not located in an MSA. As our loan performance data start in February 2020, the remaining missing COVID-19 observations are related to monthly loan performance data that date prior to March 2020 - date at which COVID-19 cases started to be tracked. 


As briefly shown in question 2, we have between 1 and 17 consecutive observation for each loan contract. Nonetheless, the number of loans for which we have only 1 period of observation is very small compared to the total number of loans of the dataset - 123 out 346,724, or 0.3%. All the other loans therefore have at least 2 consecutive observations.


None of our loan performance data display discontinuities between observations.   

#### 4. Compute between transformed and within transformed variables for all variables. Present a table with the within, between and pooled variance for each variable. Compute the share of between and within variance in the total variance for each variable. Comment these results.


- Pooled deviation = $x_{i,t} - \overline{x}$
- Within deviation = $x_{i, t} - \overline{x}_i$
- Between deviation = $\overline{x}_{i} - \overline{x}$

```{r}
pooled <- DB_test %>% 
  mutate_at(vars(Delinquency_Status:Fintech), ~ . -  mean(., na.rm = T)) %>% 
  summarise(across(c(Delinquency_Status:Fintech), ~var(., na.rm = T))) %>% 
  pivot_longer(c(Delinquency_Status:Fintech), names_to = 'variable', values_to = 'Pooled')
```

```{r}
# Within transformation
within_transformation <- DB_test %>% 
  group_by(Loan_Seq_Number) %>% 
  mutate_at(vars(Delinquency_Status:Fintech), ~ . -  mean(., na.rm = T)) %>% 
  ungroup() %>% 
  summarise(across(c(Delinquency_Status:Fintech), ~var(., na.rm = T))) %>% 
  pivot_longer(c(Delinquency_Status:Fintech), names_to = 'variable', values_to = 'Within')
```

```{r}
between_transformation <- DB_test %>% 
  group_by(Loan_Seq_Number) %>% 
  mutate_at(vars(Delinquency_Status:Fintech), ~  mean(., na.rm = T)) %>% 
  ungroup() %>% 
  summarise(across(c(Delinquency_Status:Fintech), ~var(., na.rm = T))) %>% 
  pivot_longer(c(Delinquency_Status:Fintech), names_to = 'variable', values_to = 'Between')
```


```{r}
pooled %>% 
  left_join(within_transformation, by = 'variable') %>% 
  left_join(between_transformation, by = 'variable') %>% 
  kable() %>%
kable_styling(latex_options = c("striped", "hold_position"))
```




\newpage


#### 5. Plot the distribution of the within and between transformed dependent variable and of you key (preferred) explanatory variable (not all the explanatory variable) [in Burnside and Dollar: GDP growth and foreign aid EDA/GDP], using on the same graph an histogram, a normal law with same empirical mean and standard error and a kernel continuous approximation. Comment the between and within difference for each variable, and compare within/within for dependent and explanatory variable, and between/between for dependent and explanatory variable: kurtosis, skewness, non-normality, high leverage observation (far from the mean), several modes (mixture of distribution)?


Definitions of between and within transformation: XXX

We carry out the calculation of within and between transformations for all variables except the binary variables - namely the lender type - because XXX. 


```{r}
within_transformation_graph <- DB_test %>% 
  group_by(Loan_Seq_Number) %>% 
  mutate_at(vars(Delinquency_Status:Fintech), ~ . -  mean(., na.rm = T)) %>% 
  ungroup() 

between_transformation_graph <- DB_test %>% 
  group_by(Loan_Seq_Number) %>% 
  mutate_at(vars(Delinquency_Status:Fintech), ~  mean(., na.rm = T)) %>% 
  ungroup() 
```


```{r}
within_between_plot <- function(col, adjust = 1) {
  # col is the name of the variable we're interested in
  # adjust is used to smooth the kernel curve (the black one)
  
  within_data <- within_transformation_graph %>% 
  select( {{ col }} ) %>% 
  drop_na() 
  
  between_data <- between_transformation_graph %>% 
  select( {{ col }} ) %>% 
  drop_na()
  
  # Get the name of the variable for the title plot
  col_name <- within_data %>% names()


within_plot <- ggplot(within_data, aes( {{ col }} )) +      
  # To compute the histogram 
  geom_histogram(aes(y = ..density..)) +
  # To compute the normal curve
  stat_function(fun = dnorm,
                args = list(mean = mean(within_data %>% pull()), # there's only 1 column
                            sd = sd(within_data %>% pull())), # pull is like within_data$col
                col = "#1b98e0",
                size = 1) +
  # To compute the kernel distribution
  geom_density(adjust = adjust)  + 
  labs(title = paste('Within transformation for ', col_name))

between_plot <- ggplot(between_data, aes( {{ col }} )) +        
  geom_histogram(aes(y = ..density..)) +
  stat_function(fun = dnorm,
                args = list(mean = mean(between_data %>% pull()),
                            sd = sd(between_data %>% pull())),
                col = "#1b98e0",
                size = 1) +
  geom_density(adjust = adjust)  + 
  labs(title = paste('Between transformation for ', col_name))

within_plot + between_plot
}
```


```{r fig.height = 7, fig.width = 12}
within_between_plot(confirmed, adjust = 10) & theme_bw()
```

```{r fig.height = 8, fig.width = 14}
within_between_plot(E_LoanToValue, adjust = 10)  & theme_bw()
```






#### 6. Plot boxplot of within distribution and between distribution for the dependent variable and the key explanatory variables. Comment that you find the same insights from question 5.

```{r}
boxplot_plot <- function(data, col, x_title) {
  
  data %>% 
  ggplot(aes(x = {{ col }} )) +
  geom_boxplot() +
  coord_flip() +
    labs(y = x_title, x = '') +
    theme_minimal()
  
}
```


```{r}
boxplot_plot(within_transformation_graph, confirmed, 'Confirmed within') +
  boxplot_plot(within_transformation_graph, E_LoanToValue, 'E_LoanToValue within') +
  boxplot_plot(between_transformation_graph, confirmed, 'Confirmed between') +
  boxplot_plot(between_transformation_graph, E_LoanToValue, 'E_LoanToValue between') +
  plot_layout(ncol = 4)
```



\newpage

#### 7. Compute univariate descriptive statistics (min, Q1, median, Q3, max, mean, standard error) for Within and Between transformed variables. Is the mean different from the median and why? How many standard errors from the mean are the min and max extremes (report (MAX-average)/standard error and (MIN-average)/standard error in the tables)?


```{r}
univ_stats <- function(data, col, title) {
  
  data %>% 
  select({{ col }}) %>% 
  summarise(mean = mean( {{ col }}, na.rm = T),
            median = median( {{ col }}, na.rm = T),
            std = sd( {{ col }}, na.rm = T),
            min = min( {{ col }}, na.rm = T),
            max = max( {{ col }}, na.rm = T),
            q25 = quantile( {{ col }}, probs = c(0.25), na.rm = T),
            q75 = quantile( {{ col }}, probs = c(0.75), na.rm = T)) %>% 
  pivot_longer(mean:q75, names_to = ' ', values_to = title)
  
}
```


```{r}
univ_stats(within_transformation_graph, confirmed, 'Confirmed Within') %>% 
  left_join( univ_stats(between_transformation_graph, confirmed, 'Confirmed Between'), by =' ') %>%
  left_join( univ_stats(within_transformation_graph, confirmed, 'E_LoanToValue Within'), by =' ') %>%
  left_join( univ_stats(between_transformation_graph, confirmed, 'E_LoanToValue Between'), by =' ') %>% 
  kable() %>%
kable_styling(latex_options = c("striped", "hold_position"))
```



\newpage

#### 8. Plot the boxplot of within transformed dependent variable and the key explanatory variable by a few individual (all of them if N around 50) and only the first 20 of them for larger data set. Comment on their differences of standard errors and means for each individuals

\newpage

#### 9. Compare and comment the within and between transformed bivariate correlation matrix for all variables (include a time trend 1,2,.,T). Check poor simple correlation with the dependent variables and high correlation between explanatory variables.

\newpage



#### 10. Comment the bivariate auto-correlation and trend-correlations (check the number of observations).

\newpage

#### 11. Comment the bivariate graphs with linear, quadratic and Lowess fit for dependent and key explanatory variable (aid/gdp and growth of gdp): Within transformed, Between transformed.


\newpage


#### 12. Comment the results of estimations of Between, Within (fixed effects, (fe)) and Mundlak (random effects (re) including all X(i.) as regressors), two-way fixed effects (add year dummies in fe regression) and First differences, including all explanatory variables except the ones with high near-multicollinearity in their respective between or within space.

\newpage

#### 13. If one of your variable is time-invariant z(i) (Institutional quality ICRG for Burnside Dollar), run a baseline Hausman Taylor estimation including all X(i.) as instruments. Comment the results.

\newpage

#### 14. If one of your variable is time-invariant z(i) (Institutional quality ICRG for Burnside Dollar), run a between regression on z(i) explained by X(i.) and other time invariant variable (only with N observations). If the R2 is low, this may signal X(i.) are weak instruments poorly correlated with the variable z(i) to be instrumented. Comment.


\newpage

#### 15. Optional: mention or propose improvements to the Python, STATA, SAS or R code (copy it here). Optional: propose improvements, additional insights, and you do not know how to code them.

\newpage

## PART B (update results)

#### 1. Download 5 panel data variables from World Bank and/or IMF and/or FRED databases for the recent period (1990-2020) and for the largest coverage of emerging economies: GDP/head, GDP/head PPP-adjusted (very last update), Log(population), Foreign aid/GDP (ODA), of log an index of corruption (or good public sector governance) from the World Bank. From now on, consider as your sample only country-year observations which are available for ALL the 5 variables for at least TWO CONSECUTIVE years for a given country. The full class may coordinate for this updated database. In all the following questions except perhaps the last one, the PPP adjusted GDP is not used. So we consider 4 variables excluding GDP/head PPP adjusted.

We download yearly data for 88 countries over 23 periods (between 1996 and 2019) for the following variables: (i) the World Bank corruption index, (ii) GDP per capita in euros, (iii) PPP-adjusted GDP per capita (iv) foreign aid - as % of Gross National Income and per capita - and (v) population.     

```{r}
# Import Data 
# Inside the Data folder, get all the .RDS files except MSA_Large
panel_data <- list.files(path =  'Data/', pattern="*[^(MSA_Large)].RDS") %>% 
  map(., ~read_rds(paste0('Data/', .))) %>% 
  reduce(inner_join, by = c('iso2c', 'country', 'year'))

panel_data
```

Based on the below table, as we lack observations for the years 1997, 1999 and 2001, we restrict our analysis to the 2002-2019 period for those 88 countries.  

```{r}
panel_data %>% 
  count(year)
```

We therefore remove the years 1996, 1998 and 2000 from our sample. 

```{r}
panel_data <- panel_data %>%
  filter(!year %in% c(1996, 1998, 2000))

panel_data %>% 
  count(country)
```

As we are concerned with the impact of foreign aid on economic growth, we also remove from our sample countries that have a negative net ODA. 

```{r}
# We remove them because they have negative ODA for at least one year
# We would need to find Gross ODA in order to have only positives values
country_to_remove <- panel_data %>% 
  group_by(country) %>% 
  filter(oda_net < 0) %>% 
  distinct(country) %>% 
  pull()

country_to_remove
```
We therefore arrive to the following final dataset, which comprises 77 countries over 18 years (2002-2019). 

```{r}
panel_data <- panel_data %>% 
  filter(!country %in% country_to_remove)

panel_data %>% 
  count(country)
```

\newpage

#### 2. Compute 2 growth rates using the difference of log: the growth of GDP/head (difference of log, denoted GDPg), the growth of foreign aid ODAg (but NOT the growth for foreign aid/GDP: remove the difference of log of GDP from the difference of log of foreign aid/GDP).


```{r}
panel_data <- panel_data %>% 
  arrange(country, year) %>% 
  group_by(country) %>% 
  mutate(g_gdp_per_cap = log(gdp_per_cap) - dplyr::lag(log(gdp_per_cap)),
         g_population = log(population) - dplyr::lag(log(population)),
         g_oda_net = log(oda_net) - dplyr::lag(log(oda_net))) %>% 
  ungroup()
```


\newpage

#### 3. Compute the between average over time for the first period and for the second period for the 6 variables. Provide the top 10 of countries for ODA/GDP with average over time for each period.

We separate our dataset in two periods of approximately equal size in terms of available observations: 2002-2013 for Period 1 and 2014-2019 for Period 2.

As in Jia and Williamson (2018), we compare the countries that are the top recipients of foreign aid compared to GDP in those two subsets of the database.

```{r}
Period_1 <- subset(panel_data, year == 2002:2013)

Period_1 %>% 
  group_by(country) %>% 
  mutate(oda_net_gdp_cap = oda_net / gdp_per_cap) %>% 
  # Summarise is used  to transform our dataframe and calculate the mean for each country
  summarise(across(where(is.double), ~mean(., na.rm = T))) %>% # across() applies a function (here the mean) given a condition (is.double)
  arrange(desc(oda_net_gdp_cap)) %>% 
  relocate(country, oda_net_gdp_cap) %>% 
  slice_max(oda_net_gdp_cap, n = 10)
```

```{r}
Period_2 <- subset(panel_data, year == 2014:2019)

Period_2  %>% 
  group_by(country) %>% 
  mutate(oda_net_gdp_cap = oda_net / gdp_per_cap) %>% 
  # Summarise is used  to transform our dataframe and calculate the mean for each country
  summarise(across(where(is.double), ~mean(., na.rm = T))) %>% # across() applies a function (here the mean) given a condition (is.double)
  arrange(desc(oda_net_gdp_cap)) %>% 
  relocate(country, oda_net_gdp_cap) %>% 
  slice_max(oda_net_gdp_cap, n = 10)

```

We notice that the 10 countries with the highest ODA/GDP average over the period differ between those two samples. While Malawi, Rwanda, Sierra Leone, Niger and the Central African Republic are top recipients in foreign aid / GDP on average for both periods 1 and 2, Burkina Faso, Cabo Verde and Tanzania have a lower relative to period 1 and are no more among the top 10 recipients in period 2. 

Average ODA/GDP are higher in period 2 - ranging from 10.4% to 32% compared to 7.9% and 17% in period 1 - explained by the presence of other countries compared to period 1, namely the Gambia, Guinea-Bissau, the Solomon Islands, Burundi and Vanuatu. 

The magnitude of the change in the average  ODA/GDP ratio for the Central African republic is the most striking, from 17% in period 1 to 32% on average over the period 2.

\newpage

#### 4. Compute the proportion of country-years observations in your database such that 0\<=ODA/GDP\<0.5%

Now turning to the countries with the lowest ODA/GDP ratios, 23 countries of our dataset have ratios between 0% and 0.5%. Notably, Algeria, Brazil, Costa Rica, Dominican Republic, India, Mexico and Turkey have a ratio lower than 0.5% for all the 18 years of observations.

Albania, Côte d'Ivoire, Iraq and Vietnam, while having among the lowest ODA/GDP ratios, have an ODA/GDP lower than 0.5% for only 1 year of observation.  

```{r}
panel_data %>% 
  group_by(country) %>% 
  mutate(oda_net_gdp_cap = oda_net / gdp_per_cap) %>% 
  filter(oda_net_gdp_cap >= 0,
         oda_net_gdp_cap < 0.005) %>% 
  count(country) %>% 
  mutate(prop = round(n / 18, 2)) %>% 
  arrange(desc(n))
```

\newpage

#### 5. Compute the between and within transformations of the 6 variables over the full period. Provide the 4 histograms for ODA/GPD, growth of ODA, growth of GDP/head, corruption index for both between and within transformed variables (hence 8 histograms). Comment.

Definitions of the between and within transformation: XXX. 

```{r}
# Between transformation
between_transformation <- panel_data %>% 
  group_by(country) %>% 
  mutate(oda_net_gdp_cap = oda_net / gdp_per_cap) %>% 
  summarise(across(where(is.double), mean, na.rm = T))
```

The important message of the below charts in the non-normality of the 'Between-transformed' variables. While we have no numeric information regarding the parameters of those distributions, we notice that the Between-transformed 'corruption' variable displays a positive skewness - it has a relatively fatter right tail. The Between-transformed 'ODA / GDP per capita' rather has the shape of a gamma distribution. 


```{r}
between_transformation %>% 
  select(country, oda_net_gdp_cap, g_oda_net, g_gdp_per_cap, corruption) %>% 
  pivot_longer(-country) %>% 
  ggplot(aes(x = value)) +
  geom_histogram() +
  facet_wrap(~name, scales = 'free')
```
The most striking characteristic in the 'within-transformed' case is the apparent normality of the corruption variable and the 'ODA / GDP per capita' variable. Although those charts give no precisions about the kurtosis of those within-transformed variable, we can at least conclude that those variables are evenly-distributed around the mean. 

```{r}
# Within transformation
panel_data %>% 
  group_by(country) %>% 
  mutate(oda_net_gdp_cap = oda_net / gdp_per_cap) %>% 
  mutate(across(where(is.double),~ . -  mean(., na.rm = T))) %>% 
  select(country, oda_net_gdp_cap, g_oda_net, g_gdp_per_cap, corruption) %>% 
  pivot_longer(-country) %>% 
  ggplot(aes(x = value)) +
  geom_histogram(bins = 50) +
  facet_wrap(~name, scales = 'free')

```


\newpage

#### 6. Provide the 3 bivariate graphs (with acronyms for observations NIC12, for Nicaragua 2012) for between and within (hence 6 graphs) of growth of GDP/head (vertical axis) with (1) ODA/GDP, (2) the growth of ODA; of corruption index with ODA/GDP. Comment.


```{r}
between_transformation %>% 
  pivot_longer(-c(country, g_gdp_per_cap)) %>% 
  filter(name %in% c('g_oda_net', 'oda_net_gdp_cap')) %>% 
  ggplot(aes(x = value, y = g_gdp_per_cap, label = country)) + 
  geom_point() + 
  facet_wrap(~name, scales = 'free') + 
   geom_text_repel(size = 2.5) +
  labs(title = 'Between Transformation', 
       x = '',
       y = 'Growth of GDP per capita (constant 2015$)')
```

```{r}
between_transformation %>% 
  ggplot(aes(x = oda_net_gdp_cap, y = corruption, label = country)) + 
  geom_point() +
  geom_text_repel(size = 2.5) +
  labs(title = 'Between Transformation', 
       x = 'Net ODA / GDP  (per capita)',
       y = 'Corruption')
```


```{r}
within_bivariate <- panel_data %>% 
  group_by(country) %>% 
  mutate(oda_net_gdp_cap = oda_net / gdp_per_cap) %>% 
  mutate(across(where(is.double),~ . -  mean(., na.rm = T)),
         # '..$' : Regex pour sélectionner les deux (un point = n'importe quelle terme)
         # derniers ($) charactères du vecteur Year
         # '^..' : ^ pour selectionner les deux premiers charactères
         # '..$' : $ pour selectionner les deux derniers charactères
         country_year = paste0(country, '-', str_extract_all(year, '..$'))) %>% 
  ungroup() %>% 
  select(country_year, country, year, gdp_per_cap, oda_net_gdp_cap, g_oda_net, g_gdp_per_cap, corruption) 
```


```{r}
fatal_btw_mod <- plm(corruption ~ gdp_per_cap, 
                    data = within_bivariate,
                    index = c("country", "year"), 
                    model = "within")

summary(fatal_btw_mod)
```

```{r}
within_bivariate %>% lm(corruption ~ -1 + gdp_per_cap, data = .)
```






```{r}
plot_biv <- function(data, x, y) {
  
  data %>% 
    ggplot(aes(x = {{ x }}, y = {{ y }}, label = country_year)) +
    geom_point(size = 1, alpha = 0.5) +
    geom_text_repel(size=2) + 
    geom_smooth(method = lm, se = FALSE, color = 'blue', size = 0.7) +
    geom_smooth(method = loess, se = FALSE, color = 'red', size = 0.7) +
    geom_smooth(method = lm, formula = y ~ splines::bs(x, 3), se = FALSE, color = 'orange', size = 0.7)
  
}
```


```{r}
within_bivariate %>% 
  plot_biv(x = oda_net_gdp_cap, y = g_gdp_per_cap)
```

```{r}
within_bivariate %>% 
  plot_biv(x = g_oda_net, y = g_gdp_per_cap)
```

```{r}
within_bivariate %>% 
  plot_biv(x = oda_net_gdp_cap, y = corruption)
```

\newpage

#### 7. Comment the between versus within correlation matrix for the 6 variables in this order

```{r}
between_transformation %>% 
  select(c(g_oda_net, g_gdp_per_cap, gdp_per_cap, oda_net_gdp_cap, corruption, population)) %>% 
  #cor()%>% 
datasummary_correlation(title = 'Correlation matrix') %>%
kable_styling(latex_options = c("striped", "hold_position")) 
```

\newpage


```{r}
fatal_fe_mod <- plm(corruption ~ gdp_per_cap, 
                    data = panel_data,
                    index = c("iso2c", "year"), 
                    model = "between")

summary(fatal_fe_mod)
```

```{r}
between_transformation %>% lm(corruption ~ gdp_per_cap, data = .)
```
#### 8. Run a one-way fixed effect foreign aid regression on ODA/GDP function of Ln(Population) and Ln(GDP/head). Comment.

\newpage

#### 9. Run a one-way fixed effect of Corruption Index function of Ln(GDP/head), of ODA/GDP and the growth of ODA. Comment.

\newpage

#### 10. Run a one-way fixed effect with the growth of GDP/head function of Ln(GDP/head), ODA/GDP, the growth of ODA and the Corruption index.

\newpage

#### 11. Propose an additional interesting estimation using this database.

\newpage

#### 12. Compute the between and within transformations of the 11 variables over the full period. Provide histograms for ODA/GPD, growth of ODA, growth of GDP/head for both between and within transformed. Comment.

```{r eval=FALSE, include=FALSE}
fe_model_plm <- plm(inv ~ capital, data = Grunfeld, 
                    index = c("firm", "year"), 
                    effect = "individual", model = "within")

summary(fe_model_plm)
```


```{r}
panel_data %>%
  ggplot(aes(x = year, y = gdp_ppp)) +
  geom_point() +
  geom_line(data = panel_data %>% group_by(year) %>% summarise(gdp_mean = mean(gdp_ppp)),
            aes(x = year, y = gdp_mean), col = "blue") +
  scale_x_continuous(labels = as.character(unique(panel_data$year)), 
                     breaks = unique(panel_data$year)) +
  labs(x = "Year", y = "GDP Per capita") +
  theme(axis.text.x = element_text(angle = 90))
```

